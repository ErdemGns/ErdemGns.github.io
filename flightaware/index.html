<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 1%;
    }

    #map {
      width: 75%;
      height: 50%;
    }
  </style>

  <title>Airplane</title>
  <link rel="shortcut icon" href="airplane.png" type="image/x-icon">

</head>

<body>
  <h1>Uçak Hareket Haritası</h1>
  <div id="map"></div>

  <script>
    //Making a map and tiles
    const map = L.map('map').setView([40, 35], 5);
    const attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributonrs';
    const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    const tiles = L.tileLayer(tileUrl, {
      attribution
    });
    tiles.addTo(map);
    const api_url = 'https://opensky-network.org/api/states/all?lamin=35.8389&lomin=25&lamax=45&lomax=45';

    //////////////////////////////////////////

    function fetchData() {
      return fetch(api_url)
        .then((res) => {
          return res.json();
        })
        .then((res) => {
          return res.states.filter((state) => {
            return (state[5]) && (state[6]);
          });
        })
        .catch((err) => {
          if (err) throw err
        });
    }

    function plotStates(map, markers) {
      fetchData().then(function(states) {
        states.forEach((state) => {
          const lat = state[6],
            lng = state[5],
            icao24 = state[0];

          if (markers[icao24]) {
            markers[icao24].setLatLng([lat, lng]);
          } else {
            const airplaneIcon = L.icon({
              iconUrl: 'airplane.png',
              iconSize: [17, 17],
              //iconAnchor: [25, 16],
            });
            markers[icao24] = L.marker([lat, lng], {
              icon: airplaneIcon
            });
            markers[icao24].addTo(map);
          }
        });
        setTimeout(() => plotStates(map, markers), 1000);
      });
    }

    const markers = {};
    plotStates(map, markers);
  </script>
</body>

</html>
